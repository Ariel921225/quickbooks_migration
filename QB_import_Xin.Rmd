---
title: "Untitled"
author: "Xin Yu"
date: "Nov 17, 2019"
output: html_document
---

```{r, warning=FALSE, message=FALSE}
library(readxl)
library(dplyr)
library(zoo)
library(xlsx)

first_sheet <- read_excel("../quickbooks.xlsx",sheet=1)

if(length(first_sheet)==0) {data<-read_xlsx("../quickbooks.xlsx",sheet=2,col_names = FALSE)
} else{
  data<-first_sheet
}


```

```{r}
data <- data[,colSums(is.na(data)) < nrow(data)]

Date_col <- grep("Date", data)
Date_row <- which(data[,grep("Date", data)] == "Date")
```

```{r}
if(Date_row > 1) data<-data[-(1:Date_row-1),]

data <- data[,colSums(is.na(data)) < nrow(data)-1]

data[1,1]<-"full_name"
colnames(data) <- data[1,]
data <- data[-1,]
```

```{r}
t<-as.numeric(grep("Date", names(data)))-1

for(i in 1:t){
  data[,i]<- na.locf(data[,i],na.rm = F)
}

data <- data[which(!is.na(data[,"Date"])),] %>% 
  subset(select = -c(Balance)) %>% 
  subset(Amount >= 0)

payment_method<-c("check")
data<-data.frame(data,payment_method)


data1<-subset(data,is.na(data$Num)==TRUE,drop = FALSE)
data1$payment_method<-"other"
data2<-subset(data,is.na(data$Num)==FALSE,drop = FALSE )
data2$Num<-paste0("Num:",data2$Num)
data<-rbind(data1,data2)
data3<-subset(data,data$Amount==0,drop=FALSE)
if(nrow(data3)>0) data3$payment_method<-"in_kind"
data4<-subset(data,data$Amount>0,drop = FALSE)
data<-rbind(data3,data4)


```

```{r}
data<-rename(data, payment_description=Num,description=Memo,Donation_date=Date)

data$Donation_date<-as.Date(as.numeric(data$Donation_date),origin="1899-12-30")


d<-c("Donation_date","payment_method","Amount","payment_description","description")

data<-data[, c(d, sort(setdiff(names(data), d)))]

write.xlsx(data, "clean_quickbooks.xlsx", showNA=FALSE)


```
























