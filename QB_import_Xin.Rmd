---
title: "Untitled"
author: "Xin Yu"
date: "Nov 17, 2019"
output: html_document
---

```{r, warning=FALSE, message=FALSE}
library(readxl)
library(dplyr)
library(zoo)
library(xlsx)

first_sheet <- read_excel("../quickbooks.xlsx",sheet=1)

if(length(first_sheet)==0) {data<-read_xlsx("../quickbooks.xlsx",sheet=2,col_names = FALSE)
} else{
  data<-first_sheet
}


```

```{r}
data <- data[,colSums(is.na(data)) < nrow(data)]

Date_col <- grep("Date", data)
Date_row <- which(data[,grep("Date", data)] == "Date")
```

```{r}
if(Date_row > 1) data<-data[-(1:Date_row-1),]

data <- data[,colSums(is.na(data)) < nrow(data)-1]

data[1,1]<-"full_name"
colnames(data) <- data[1,]
data <- data[-1,]
```

```{r}
t<-as.numeric(grep("Date", names(data)))-1

for(i in 1:t){
  data[,i]<- na.locf(data[,i],na.rm = F)
}

data <- data[which(!is.na(data[,"Date"])),] %>% 
  subset(select = -c(Balance)) %>% 
  subset(Amount >= 0)

payment_method<-c("check")
data2<-data.frame(data,payment_method)


data3<-subset(data2,is.na(data2$Num)==TRUE,drop = FALSE)
data3$payment_method<-"other"
data4<-subset(data2,is.na(data2$Num)==FALSE,drop = FALSE )
data4$Num<-paste0("Num:",data4$Num)
all_data1<-rbind(data3,data4)
data5<-subset(all_data1,all_data1$Amount==0,drop=FALSE)
if(nrow(data5)>0) data5$payment_method<-"in_kind"
data6<-subset(all_data1,all_data1$Amount>0,drop = FALSE)
all_data<-rbind(data5,data6)




```

```{r}
all_data<-rename(all_data, payment_description=Num)
all_data<-rename(all_data, description=Memo)
all_data$Date<-as.Date(as.numeric(all_data$Date),origin="1899-12-30")
all_data<-rename(all_data, Donation_date=Date)

c<-c("Donation_date","payment_method","Amount","payment_description","description")

last_data<-all_data[, c(c, sort(setdiff(names(all_data), c)))]

write.xlsx(last_data, "clean_quickbooks.xlsx", showNA=FALSE)


```
























